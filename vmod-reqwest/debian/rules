#!/usr/bin/make -f
DEB_BUILD_OPTIONS=noddebs

CARGO=~/.cargo/bin/cargo
override_dh_auto_configure:
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | bash -s -- -y
	${CARGO} fetch --locked

override_dh_auto_build:
	${CARGO} build --frozen --release

override_dh_auto_install:
	install -Dt debian/vmod-reqwest/usr/lib/varnish/vmods/ target/release/libvmod_reqwest.so

override_dh_auto_test:
	# VARNISHTEST_DURATION=20s is needed because some test may go slightly over the 5s timeout
	# export RUST_BACKTRACE=1; export VARNISHTEST_DURATION=20s; ${CARGO} test --frozen --release
	true

%:
	dh $@

num=\#
VARNISHD_ABI = $(shell \
	printf '$(num)include "vcs_version.h"\nVCS_Version\n' | \
	cpp - -Iinclude | \
	tail -1 | \
	tr -d '"')

VARNISHD_VRT = $(shell \
	printf '$(num)include "vdef.h"\n$(num)include "vrt.h"\n%s.%s\n' \
		VRT_MAJOR_VERSION VRT_MINOR_VERSION | \
	cpp - -Iinclude | \
	tail -1 | \
	tr -c -d '[0-9.]')

override_dh_gencontrol:
	echo "varnishd:ABI=varnishd-abi-$(VARNISHD_ABI)" >> debian/substvars
	echo "varnishd:VRT=varnishd-vrt (= $(VARNISHD_VRT))" >> debian/substvars

	if [ -n "$$DEBIAN_OVERRIDE_BINARY_VERSION" ]; then \
		dh_gencontrol -- -Tdebian/substvars -v$$DEBIAN_OVERRIDE_BINARY_VERSION; \
	else \
		dh_gencontrol -- -Tdebian/substvars; \
	fi
